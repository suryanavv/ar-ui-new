name: Deploy Frontend to Staging

on:
  push:
    branches: [staging-dev]
  workflow_dispatch:

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to Frontend EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.FRONTEND_HOST }}
          username: ${{ secrets.FRONTEND_USER }}
          key: ${{ secrets.FRONTEND_SSH_KEY }}
          script: |
            set -e
            
            echo "ğŸ”„ Starting frontend deployment..."
            cd /home/ubuntu/ar-ui/current
            
            echo "ğŸ“¦ Pulling latest code..."
            git fetch origin
            git reset --hard origin/staging-dev
            
            echo "ğŸ”‘ Copying environment file..."
            cp /home/ubuntu/ar-ui/.env .env
            
            echo "ğŸ“š Installing dependencies..."
            rm -f package-lock.json
            npm install --legacy-peer-deps
            
            echo "ğŸ—ï¸  Building production bundle..."
            npm run build
            
            echo "ğŸ” Verifying build..."
            # Check that critical components are in the build
            if ! grep -q "Authorization" dist/assets/*.js; then
              echo "âŒ Build verification failed: Authorization interceptor missing"
              exit 1
            fi
            
            echo "ğŸ“ Deploying to nginx..."
            sudo rm -rf /var/www/ar-ui/html/*
            sudo cp -r dist/* /var/www/ar-ui/html/
            
            echo "ğŸ”„ Reloading nginx..."
            sudo nginx -t
            sudo systemctl reload nginx
            
            echo "ğŸ¥ Health check..."
            curl -f https://staging-ar.clinqly.ai/ || (echo "âŒ Health check failed" && exit 1)
            
            echo "âœ… Frontend deployment complete!"
            echo "ğŸŒ Live at: https://staging-ar.clinqly.ai"
